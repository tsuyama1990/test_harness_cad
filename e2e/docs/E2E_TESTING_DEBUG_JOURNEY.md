### E2Eテスト デバッグの経緯と結論

#### 1. 目的
Playwrightを使用し、ハーネスエディタの基本的なユーザー操作（コンポーネントのドラッグ＆ドロップ、結線、データ保存）を保証するE2Eテストを確立する。

#### 2. 初期問題：APIモックの失敗
- **症状**: テストを実行すると、画面が正常に表示されず、テストが要素を見つけられずに失敗する。
- **原因**: Playwrightのテストサーバー(`npm run dev`)がFastAPIバックエンドを起動しておらず、フロントエンドからのAPIリクエスト(`http://localhost:5173/api/...`)がViteのプロキシ経由で存在しないバックエンド(`http://localhost:8000`)に転送され、500エラーとなっていた。

#### 3. デバッグの経緯

##### 試行1: Viteプロキシの無効化
- **対策**: Playwrightの`webServer`コマンドを`DISABLE_PROXY=true npm run dev`に変更し、テスト実行時のみプロキシを無効化。
- **結果**: 500エラーは解消。しかし、新たにフロントエンドで`TypeError: components.filter is not a function`が発生。
- **分析**: APIリクエストがバックエンドには行かなくなったが、Playwrightの`page.route`によるモックが正しく機能しておらず、フロントエンドが期待する配列(Array)ではないデータ（おそらく未パースのJSON文字列）を受け取っていた。

##### 試行2: APIレスポンス形式の特定
- **対策**: `page.route`の記述を`json:`から`body: JSON.stringify(...)`に変更したり、レスポンスをコンソール出力するなど、様々な方法でモックが返すデータの形式を特定しようと試みた。
- **結果**:
    - `page.on('response')`リスナーを追加すると、Viteサーバー自体が不安定になり、CSSやJSファイルを含む**全てのアセットに対して`net::ERR_EMPTY_RESPONSE`を返す**という壊滅的な状態に陥った。
    - `api.ts`で手動`JSON.parse()`を追加すると、今度は`index.html`のHTML文字列をパースしようとして`SyntaxError`が発生した。

##### 試行3: `page.route`パターンの修正（根本原因の特定）
- **分析**: `SyntaxError`から、`page.route`がAPIリクエストを全く捕捉できておらず、Viteが代替として`index.html`を返していることが最終的に確定した。
- **対策**: `page.route`のURLマッチングパターンを、より堅牢なglob (`**/api/...`)や正規表現 (`/api\/.../`) に変更した。これはPlaywrightのベストプラクティスに沿った正しい修正だった。
- **最終結果**: パターンを正しく修正したにもかかわらず、**またしてもViteサーバーが不安定化し、全てのアセットに対して`net::ERR_EMPTY_RESPONSE`を返す**状態に戻ってしまった。

#### 4. 結論：テスト環境の根本的な非互換性

**Playwrightの`webServer`機能でViteを起動し、かつ`page.route`でそのViteサーバーへのリクエストをモックするという構成は、このプロジェクトにおいて根本的な非互換性・不安定性を抱えています。**

APIリクエストを正しく捕捉しようとすると（`**/api/...`など）、Viteサーバーが応答しなくなるという、解決不能なジレンマに陥っています。これは個々のコードの問題ではなく、ツール間の連携問題である可能性が極めて高いです。

#### 5. 今後の推奨事項

これ以上のデバッグは困難なため、アプローチの変更を推奨します。

1.  **サーバーの手動起動**: Playwrightの`webServer`に頼らず、ターミナルを2つ使い、片方でFastAPIサーバー(`uvicorn ...`)、もう片方でViteサーバー(`npm run dev`)を**手動で**起動した状態で、Playwrightテストを実行する。これならプロキシもモックも不要です。
2.  **Cypressへの再挑戦**: 当初失敗したCypressを、現在のローカル環境で再度試す。Cypressは異なるアーキテクチャで動作するため、この問題が発生しない可能性があります。